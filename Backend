
from flask import Flask, request, jsonify, render_template, session, redirect, url_for
from pymongo import MongoClient
from urllib.parse import quote_plus
from bson import ObjectId

app = Flask(__name__)

username = "chukhanhhung"
password = "Abc123"
mongo_uri = f"mongodb+srv://{quote_plus(username)}:{quote_plus(password)}@cluster0.pvie75s.mongodb.net/?retryWrites=true&w=majority"

client = MongoClient(mongo_uri)
db = client["ABE"] 

@app.route('/login', methods=['POST'])
def login():
    data = request.get_json()
    username = data['username']
    password = data['password']

    users_collection = db.USERS
    user = users_collection.find_one({"username": username})

    if user and user['password'] == password:
        return jsonify({"message": "Đăng nhập thành công"})
    else:
        return jsonify({"message": "Tên đăng nhập hoặc mật khẩu không chính xác"})
    
@app.route('/add_user', methods=['POST'])
def add_user():
    data = request.get_json()

    if 'username' not in data or 'password' not in data:
        return jsonify({'message': 'Dữ liệu không hợp lệ'}), 400

    new_user = {
        'username': data['username'],
        'password': data['password'],
        'fullname': data.get('fullname', ''),
        'dob': data.get('dob', ''),
        'citizenshipid': data.get('citizenshipid', ''),
        'hometown': data.get('hometown', ''),
        'phonenumber': data.get('phonenumber', ''),
        'key_id': data.get('key_id', '')
    }

    user_collections = db.USERS
    result = user_collections.insert_one(new_user)

    return jsonify({'message': 'Người dùng đã được thêm thành công', 'user_id': str(result.inserted_id)}), 201

@app.route('/delete_user/<string:user_id>', methods=['DELETE'])
def delete_user(user_id):
    try:
        obj_id = ObjectId(user_id)

        user_collections = db.USERS
        result = user_collections.delete_one({'_id': obj_id})

        if result.deleted_count == 1:
            return jsonify({'message': 'Người dùng đã được xóa thành công'}), 200
        else:
            return jsonify({'message': 'Không tìm thấy người dùng'}), 404

    except Exception as e:
        return jsonify({'message': 'Lỗi: ' + str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True)
